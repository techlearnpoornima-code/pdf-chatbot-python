<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üè† Fully Local PDF Chatbot</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --surface2: #22263a;
      --accent: #7c6af7;
      --accent2: #a78bfa;
      --text: #e2e8f0;
      --text-muted: #8892a4;
      --border: #2d3349;
      --user-bubble: #2d2459;
      --ai-bubble: #1e2235;
      --success: #34d399;
      --danger: #f87171;
      --radius: 14px;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 24px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    header .logo { font-size: 1.5rem; }
    header h1 { font-size: 1.1rem; font-weight: 700; letter-spacing: -0.3px; }
    header .subtitle { font-size: 0.78rem; color: var(--text-muted); margin-top: 1px; }
    header .badge {
      margin-left: auto;
      background: var(--accent);
      color: #fff;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 100px;
      letter-spacing: 0.5px;
    }

    /* ‚îÄ‚îÄ Main layout ‚îÄ‚îÄ */
    .layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    .sidebar {
      width: 300px;
      flex-shrink: 0;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding: 20px;
      overflow-y: auto;
    }

    .sidebar h2 { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; }

    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 28px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--surface2);
    }
    .drop-zone:hover, .drop-zone.drag-over {
      border-color: var(--accent);
      background: #1e1b3a;
    }
    .drop-zone .icon { font-size: 2rem; margin-bottom: 8px; }
    .drop-zone p { font-size: 0.85rem; color: var(--text-muted); line-height: 1.5; }
    .drop-zone p strong { color: var(--accent2); }
    #file-input { display: none; }

    .pdf-info {
      background: var(--surface2);
      border-radius: var(--radius);
      padding: 14px;
      display: none;
      gap: 10px;
      align-items: flex-start;
    }
    .pdf-info.visible { display: flex; }
    .pdf-info .pdf-icon { font-size: 1.5rem; flex-shrink: 0; }
    .pdf-info .pdf-details { min-width: 0; }
    .pdf-info .pdf-name { font-size: 0.85rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .pdf-info .pdf-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }

    .model-info {
      background: var(--surface2);
      border-radius: var(--radius);
      padding: 14px;
      font-size: 0.8rem;
    }
    .model-info label { display: block; color: var(--text-muted); margin-bottom: 6px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .model-info input, .model-info select {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 7px 10px;
      border-radius: 8px;
      font-size: 0.82rem;
      outline: none;
      margin-bottom: 10px;
    }
    .model-info input:focus, .model-info select:focus { border-color: var(--accent); }

    .status-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: var(--radius);
      font-size: 0.8rem;
      background: var(--surface2);
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .status-dot.idle { background: var(--text-muted); }
    .status-dot.loading { background: var(--accent); animation: pulse 1s infinite; }
    .status-dot.ready { background: var(--success); }
    .status-dot.error { background: var(--danger); }

    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.3; } }

    /* ‚îÄ‚îÄ Chat area ‚îÄ‚îÄ */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      scroll-behavior: smooth;
    }

    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: var(--text-muted);
      text-align: center;
    }
    .empty-state .big-icon { font-size: 3rem; }
    .empty-state h2 { font-size: 1.1rem; color: var(--text); }
    .empty-state p { font-size: 0.85rem; max-width: 340px; line-height: 1.6; }

    .message {
      display: flex;
      gap: 12px;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; } }

    .message.user { flex-direction: row-reverse; }

    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }
    .message.user .avatar { background: var(--accent); }
    .message.ai .avatar { background: var(--surface2); border: 1px solid var(--border); }

    .bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: var(--radius);
      font-size: 0.88rem;
      line-height: 1.65;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .message.user .bubble { background: var(--user-bubble); border-bottom-right-radius: 4px; }
    .message.ai .bubble { background: var(--ai-bubble); border: 1px solid var(--border); border-bottom-left-radius: 4px; }

    .typing-indicator { display: flex; gap: 4px; padding: 4px 0; }
    .typing-indicator span {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--text-muted);
      animation: bounce 1.2s infinite;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce { 0%,80%,100% { transform: translateY(0); } 40% { transform: translateY(-6px); } }

    /* ‚îÄ‚îÄ Input area ‚îÄ‚îÄ */
    .input-area {
      padding: 16px 24px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }
    .input-row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 12px;
      transition: border-color 0.2s;
    }
    .input-row:focus-within { border-color: var(--accent); }

    #message-input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 0.88rem;
      resize: none;
      outline: none;
      max-height: 120px;
      line-height: 1.5;
      padding: 4px 0;
      font-family: inherit;
    }
    #message-input::placeholder { color: var(--text-muted); }

    #send-btn {
      background: var(--accent);
      border: none;
      border-radius: 9px;
      color: #fff;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: opacity 0.2s, transform 0.1s;
      flex-shrink: 0;
    }
    #send-btn:hover { opacity: 0.85; }
    #send-btn:active { transform: scale(0.93); }
    #send-btn:disabled { opacity: 0.35; cursor: not-allowed; }

    .hint { font-size: 0.72rem; color: var(--text-muted); margin-top: 8px; text-align: center; }

    /* ‚îÄ‚îÄ Upload button ‚îÄ‚îÄ */
    .upload-btn {
      width: 100%;
      padding: 10px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .upload-btn:hover { opacity: 0.85; }
    .upload-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .clear-btn {
      width: 100%;
      padding: 8px;
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .clear-btn:hover { color: var(--danger); border-color: var(--danger); }

    /* scrollbar */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
  </style>
</head>
<body>

<header>
  <span class="logo">üè†</span>
  <div>
    <h1>Fully Local PDF Chatbot</h1>
    <div class="subtitle">Powered by Ollama ¬∑ LangChain ¬∑ FastAPI</div>
  </div>
  <span class="badge">100% Local</span>
</header>

<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div>
      <h2>Document</h2>
      <div style="height:10px"></div>

      <div class="drop-zone" id="drop-zone">
        <div class="icon">üìÑ</div>
        <p>Drop a PDF here or <strong>click to browse</strong></p>
        <input type="file" id="file-input" accept=".pdf" />
      </div>

      <div class="pdf-info" id="pdf-info">
        <div class="pdf-icon">üìë</div>
        <div class="pdf-details">
          <div class="pdf-name" id="pdf-name">document.pdf</div>
          <div class="pdf-meta" id="pdf-meta">‚Äî</div>
        </div>
      </div>

      <div style="height:12px"></div>
      <button class="upload-btn" id="upload-btn" disabled>‚¨Ü Index PDF</button>
    </div>

    <div>
      <h2>Model Settings</h2>
      <div style="height:10px"></div>
      <div class="model-info">
        <label>Ollama Model</label>
        <input type="text" id="model-name" value="mistral" placeholder="mistral, llama3, phi3‚Ä¶" />
        <label>Ollama URL</label>
        <input type="text" id="ollama-url" value="http://localhost:11434" />
      </div>
    </div>

    <div>
      <h2>Status</h2>
      <div style="height:10px"></div>
      <div class="status-bar" id="status-bar">
        <div class="status-dot idle" id="status-dot"></div>
        <span id="status-text">Upload a PDF to begin</span>
      </div>
      <div style="height:10px"></div>
      <button class="clear-btn" id="clear-btn">üóë Clear conversation</button>
    </div>
  </aside>

  <!-- Chat -->
  <main class="chat-area">
    <div class="messages" id="messages">
      <div class="empty-state" id="empty-state">
        <div class="big-icon">üí¨</div>
        <h2>Chat with your PDF</h2>
        <p>Upload and index a PDF on the left, then ask questions about its content. Everything runs locally ‚Äî no data leaves your machine.</p>
      </div>
    </div>

    <div class="input-area">
      <div class="input-row">
        <textarea id="message-input" rows="1" placeholder="Ask a question about your PDF‚Ä¶" disabled></textarea>
        <button id="send-btn" disabled>‚û§</button>
      </div>
      <div class="hint">Press Enter to send ¬∑ Shift+Enter for newline</div>
    </div>
  </main>
</div>

<script>
  const API = '';  // same origin

  let sessionId = null;
  let chatHistory = [];
  let selectedFile = null;
  let isStreaming = false;

  // ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ
  const dropZone = document.getElementById('drop-zone');
  const fileInput = document.getElementById('file-input');
  const uploadBtn = document.getElementById('upload-btn');
  const pdfInfo = document.getElementById('pdf-info');
  const pdfName = document.getElementById('pdf-name');
  const pdfMeta = document.getElementById('pdf-meta');
  const messagesEl = document.getElementById('messages');
  const emptyState = document.getElementById('empty-state');
  const messageInput = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');
  const clearBtn = document.getElementById('clear-btn');
  const statusDot = document.getElementById('status-dot');
  const statusText = document.getElementById('status-text');

  // ‚îÄ‚îÄ File selection ‚îÄ‚îÄ
  dropZone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', e => setFile(e.target.files[0]));

  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    const f = e.dataTransfer.files[0];
    if (f && f.name.endsWith('.pdf')) setFile(f);
  });

  function setFile(file) {
    if (!file) return;
    selectedFile = file;
    pdfName.textContent = file.name;
    pdfMeta.textContent = (file.size / 1024).toFixed(0) + ' KB';
    pdfInfo.classList.add('visible');
    uploadBtn.disabled = false;
    setStatus('idle', 'Ready to index');
  }

  // ‚îÄ‚îÄ Upload / Ingest ‚îÄ‚îÄ
  uploadBtn.addEventListener('click', async () => {
    if (!selectedFile) return;
    setStatus('loading', 'Indexing PDF‚Ä¶');
    uploadBtn.disabled = true;

    const form = new FormData();
    form.append('file', selectedFile);

    try {
      const res = await fetch(`${API}/ingest`, { method: 'POST', body: form });
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      sessionId = data.session_id;
      chatHistory = [];
      pdfMeta.textContent = `${data.chunk_count} chunks indexed`;
      setStatus('ready', 'Ready ‚Äî start chatting!');
      enableChat(true);
      clearMessages();
      addMessage('ai', `‚úÖ Indexed **${selectedFile.name}** (${data.chunk_count} chunks). Ask me anything about it!`);
    } catch (err) {
      setStatus('error', 'Index failed: ' + err.message);
      uploadBtn.disabled = false;
    }
  });

  // ‚îÄ‚îÄ Chat ‚îÄ‚îÄ
  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    autoResize();
  });
  messageInput.addEventListener('input', autoResize);

  function autoResize() {
    messageInput.style.height = 'auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
  }

  async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text || !sessionId || isStreaming) return;

    isStreaming = true;
    sendBtn.disabled = true;
    messageInput.value = '';
    autoResize();

    addMessage('user', text);
    const aiEl = addMessage('ai', '', true);  // typing indicator

    try {
      const res = await fetch(`${API}/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          session_id: sessionId,
          message: text,
          chat_history: chatHistory,
        }),
      });

      if (!res.ok) throw new Error(await res.text());

      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let answer = '';
      const bubble = aiEl.querySelector('.bubble');
      bubble.innerHTML = '';  // remove typing indicator

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const lines = decoder.decode(value, { stream: true }).split('\n');
        for (const line of lines) {
          if (!line.startsWith('data: ')) continue;
          const payload = line.slice(6);
          if (payload === '[DONE]') break;
          try {
            const obj = JSON.parse(payload);
            if (obj.error) throw new Error(obj.error);
            if (obj.token) {
              answer += obj.token;
              bubble.textContent = answer;
              scrollToBottom();
            }
          } catch {}
        }
      }

      chatHistory.push({ role: 'human', content: text });
      chatHistory.push({ role: 'ai', content: answer });

    } catch (err) {
      const bubble = aiEl.querySelector('.bubble');
      bubble.textContent = '‚ö†Ô∏è Error: ' + err.message;
      bubble.style.color = 'var(--danger)';
    }

    isStreaming = false;
    sendBtn.disabled = false;
    messageInput.focus();
  }

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
  function addMessage(role, text, typing = false) {
    if (emptyState) emptyState.style.display = 'none';

    const div = document.createElement('div');
    div.className = `message ${role}`;
    div.innerHTML = `
      <div class="avatar">${role === 'user' ? 'üë§' : 'ü§ñ'}</div>
      <div class="bubble">${typing ? '<div class="typing-indicator"><span></span><span></span><span></span></div>' : escHtml(text)}</div>
    `;
    messagesEl.appendChild(div);
    scrollToBottom();
    return div;
  }

  function escHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function clearMessages() {
    messagesEl.innerHTML = '';
  }

  function scrollToBottom() {
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function enableChat(on) {
    messageInput.disabled = !on;
    sendBtn.disabled = !on;
    if (on) messageInput.focus();
  }

  function setStatus(type, text) {
    statusDot.className = `status-dot ${type}`;
    statusText.textContent = text;
  }

  clearBtn.addEventListener('click', () => {
    chatHistory = [];
    clearMessages();
    setStatus('ready', sessionId ? 'Conversation cleared' : 'Upload a PDF to begin');
  });
</script>
</body>
</html>
